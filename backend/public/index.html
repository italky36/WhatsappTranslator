<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Translator - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .modal { display: none; }
    .modal.active { display: flex; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Setup Screen -->
  <div id="setup-screen" class="hidden min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
      <h1 class="text-2xl font-bold mb-6 text-center">Initial Setup</h1>
      <p class="text-gray-600 mb-6 text-center">Create your administrator account</p>
      <form id="setup-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="setup-email" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="setup-password" required minlength="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium mb-1">Confirm Password</label>
          <input type="password" id="setup-confirm" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Create Admin</button>
        <p id="setup-error" class="text-red-500 text-sm mt-2 hidden"></p>
      </form>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="hidden min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
      <h1 class="text-2xl font-bold mb-6 text-center">Admin Login</h1>
      <form id="login-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="login-email" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="login-password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Login</button>
        <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">WhatsApp Translator Admin</h1>
        <div class="flex items-center gap-4">
          <span id="current-user-email" class="text-gray-600"></span>
          <button onclick="logout()" class="text-red-600 hover:text-red-800">Logout</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 mt-6">
      <div class="border-b border-gray-200">
        <nav class="flex gap-4">
          <button onclick="showTab('users')" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-blue-500" data-tab="users">Users</button>
          <button onclick="showTab('deepl')" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-blue-500" data-tab="deepl">DeepL Settings</button>
          <button onclick="showTab('audit')" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-blue-500" data-tab="audit">Audit Log</button>
        </nav>
      </div>

      <!-- Users Tab -->
      <div id="tab-users" class="tab-content active py-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Users</h2>
          <button onclick="showCreateUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add User</button>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usage (Monthly)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody id="users-table" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      <!-- DeepL Tab -->
      <div id="tab-deepl" class="tab-content py-6">
        <div class="bg-white rounded-lg shadow p-6 max-w-xl">
          <h2 class="text-lg font-semibold mb-4">DeepL API Configuration</h2>
          <div id="deepl-status" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <p class="text-gray-600">Loading...</p>
          </div>
          <form id="deepl-form">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-1">API Key</label>
              <input type="password" id="deepl-key" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-1">Endpoint</label>
              <select id="deepl-endpoint" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="https://api-free.deepl.com">Free (api-free.deepl.com)</option>
                <option value="https://api.deepl.com">Pro (api.deepl.com)</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button type="button" onclick="testDeepLKey()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Test Key</button>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
            </div>
            <p id="deepl-message" class="mt-2 text-sm hidden"></p>
          </form>
        </div>

        <div class="bg-white rounded-lg shadow p-6 max-w-xl mt-6">
          <h2 class="text-lg font-semibold mb-4">CORS Origins</h2>
          <div class="mb-3 p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-sm text-yellow-800">
            Changes are saved to <code class="bg-yellow-100 px-1 py-0.5 rounded">backend/.env</code> and require container recreation.
            Run: <code class="bg-yellow-100 px-1 py-0.5 rounded">docker-compose up -d --force-recreate</code>
          </div>
          <div id="cors-list" class="mb-4 text-sm text-gray-700">Loading...</div>
          <div class="flex gap-2">
            <input type="text" id="cors-extension-id" placeholder="Extension ID (e.g. ghjckhblcaeemjbicjheiikcaejhinld)" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <button type="button" onclick="addCorsOrigin()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Add</button>
          </div>
          <p id="cors-message" class="mt-2 text-sm hidden"></p>
        </div>
      </div>

      <!-- Audit Tab -->
      <div id="tab-audit" class="tab-content py-6">
        <h2 class="text-lg font-semibold mb-4">Audit Log</h2>
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actor</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
              </tr>
            </thead>
            <tbody id="audit-table" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit User Modal -->
  <div id="user-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96">
      <h3 id="modal-title" class="text-lg font-semibold mb-4">Create User</h3>
      <form id="user-form">
        <input type="hidden" id="user-id">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="user-email" required class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="user-password" minlength="8" class="w-full px-3 py-2 border rounded-lg">
          <p class="text-xs text-gray-500 mt-1">Leave empty to keep existing password</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Role</label>
          <select id="user-role" class="w-full px-3 py-2 border rounded-lg">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Status</label>
          <select id="user-status" class="w-full px-3 py-2 border rounded-lg">
            <option value="active">Active</option>
            <option value="blocked">Blocked</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="user-unlimited" class="mr-2">
            <span class="text-sm font-medium">Unlimited</span>
          </label>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Monthly Limit (chars)</label>
          <input type="number" id="user-monthly" value="500000" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium mb-1">Daily Limit (chars)</label>
          <input type="number" id="user-daily" value="50000" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="flex gap-2">
          <button type="button" onclick="closeUserModal()" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let accessToken = localStorage.getItem('accessToken');
    let refreshToken = localStorage.getItem('refreshToken');
    let currentUser = null;

    // API helpers
    async function api(path, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
      
      let response = await fetch(`${API_URL}${path}`, { ...options, headers });
      
      // Handle token refresh
      if (response.status === 401 && refreshToken) {
        const refreshed = await refreshTokens();
        if (refreshed) {
          headers['Authorization'] = `Bearer ${accessToken}`;
          response = await fetch(`${API_URL}${path}`, { ...options, headers });
        }
      }
      
      return response;
    }

    async function refreshTokens() {
      try {
        const res = await fetch(`${API_URL}/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken }),
        });
        if (res.ok) {
          const data = await res.json();
          accessToken = data.accessToken;
          refreshToken = data.refreshToken;
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('refreshToken', refreshToken);
          return true;
        }
      } catch {}
      logout();
      return false;
    }

    // Auth
    async function checkSetup() {
      const res = await fetch(`${API_URL}/setup/status`);
      const data = await res.json();
      return data.setupRequired;
    }

    async function init() {
      const setupRequired = await checkSetup();
      
      if (setupRequired) {
        showScreen('setup');
        return;
      }
      
      if (!accessToken) {
        showScreen('login');
        return;
      }
      
      // Verify token
      const res = await api('/auth/me');
      if (res.ok) {
        currentUser = await res.json();
        if (currentUser.role !== 'admin') {
          alert('Admin access required');
          logout();
          return;
        }
        showScreen('dashboard');
        document.getElementById('current-user-email').textContent = currentUser.email;
        loadUsers();
        loadDeepLStatus();
        loadCorsSettings();
        loadAuditLog();
      } else {
        showScreen('login');
      }
    }

    function showScreen(name) {
      document.getElementById('setup-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      
      if (name === 'dashboard') {
        document.getElementById('dashboard').classList.remove('hidden');
      } else {
        document.getElementById(name + '-screen').classList.remove('hidden');
      }
    }

    function logout() {
      accessToken = null;
      refreshToken = null;
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      showScreen('login');
    }

    // Setup form
    document.getElementById('setup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('setup-email').value;
      const password = document.getElementById('setup-password').value;
      const confirm = document.getElementById('setup-confirm').value;
      
      if (password !== confirm) {
        document.getElementById('setup-error').textContent = 'Passwords do not match';
        document.getElementById('setup-error').classList.remove('hidden');
        return;
      }
      
      const res = await fetch(`${API_URL}/setup/create-admin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      
      if (res.ok) {
        const data = await res.json();
        accessToken = data.accessToken;
        refreshToken = data.refreshToken;
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);
        init();
      } else {
        const err = await res.json();
        document.getElementById('setup-error').textContent = err.error?.message || 'Setup failed';
        document.getElementById('setup-error').classList.remove('hidden');
      }
    });

    // Login form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      const res = await fetch(`${API_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      
      if (res.ok) {
        const data = await res.json();
        if (data.user.role !== 'admin') {
          document.getElementById('login-error').textContent = 'Admin access required';
          document.getElementById('login-error').classList.remove('hidden');
          return;
        }
        accessToken = data.accessToken;
        refreshToken = data.refreshToken;
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);
        init();
      } else {
        const err = await res.json();
        document.getElementById('login-error').textContent = err.error?.message || 'Login failed';
        document.getElementById('login-error').classList.remove('hidden');
      }
    });

    // Tabs
    function showTab(name) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('border-blue-500', 'text-blue-600'));
      document.getElementById(`tab-${name}`).classList.add('active');
      document.querySelector(`[data-tab="${name}"]`).classList.add('border-blue-500', 'text-blue-600');
    }

    // Users
    async function loadUsers() {
      const res = await api('/admin/users');
      if (!res.ok) return;
      const data = await res.json();
      
      const tbody = document.getElementById('users-table');
      tbody.innerHTML = data.users.map(user => `
        <tr>
          <td class="px-6 py-4">${user.email}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100'}">${user.role}</span>
          </td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${user.status}</span>
          </td>
          <td class="px-6 py-4">
            ${user.limits?.isUnlimited ? '∞' : `${user.usage.monthly.toLocaleString()} / ${user.limits?.monthlyLimitChars.toLocaleString() || '-'}`}
          </td>
          <td class="px-6 py-4">
            <button onclick="editUser('${user.id}')" class="text-blue-600 hover:underline mr-2">Edit</button>
            ${user.id !== currentUser.id ? `<button onclick="deleteUser('${user.id}')" class="text-red-600 hover:underline">Delete</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function showCreateUserModal() {
      document.getElementById('modal-title').textContent = 'Create User';
      document.getElementById('user-id').value = '';
      document.getElementById('user-email').value = '';
      document.getElementById('user-password').value = '';
      document.getElementById('user-password').required = true;
      document.getElementById('user-role').value = 'user';
      document.getElementById('user-status').value = 'active';
      document.getElementById('user-unlimited').checked = false;
      document.getElementById('user-monthly').value = '500000';
      document.getElementById('user-daily').value = '50000';
      document.getElementById('user-modal').classList.add('active');
    }

    async function editUser(id) {
      const res = await api(`/admin/users/${id}`);
      if (!res.ok) return;
      const user = await res.json();
      
      document.getElementById('modal-title').textContent = 'Edit User';
      document.getElementById('user-id').value = user.id;
      document.getElementById('user-email').value = user.email;
      document.getElementById('user-password').value = '';
      document.getElementById('user-password').required = false;
      document.getElementById('user-role').value = user.role;
      document.getElementById('user-status').value = user.status;
      document.getElementById('user-unlimited').checked = user.limits?.isUnlimited || false;
      document.getElementById('user-monthly').value = user.limits?.monthlyLimitChars || 500000;
      document.getElementById('user-daily').value = user.limits?.dailyLimitChars || 50000;
      document.getElementById('user-modal').classList.add('active');
    }

    function closeUserModal() {
      document.getElementById('user-modal').classList.remove('active');
    }

    document.getElementById('user-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Email field:', document.getElementById('user-email'));
      console.log('Email value:', document.getElementById('user-email').value);
      const id = document.getElementById('user-id').value;
      const data = {
        email: document.getElementById('user-email').value,
        role: document.getElementById('user-role').value,
        status: document.getElementById('user-status').value,
        isUnlimited: document.getElementById('user-unlimited').checked,
        monthlyLimitChars: parseInt(document.getElementById('user-monthly').value),
        dailyLimitChars: parseInt(document.getElementById('user-daily').value),
      };
      
      const password = document.getElementById('user-password').value;
      if (password) data.password = password;
      
      const res = await api(id ? `/admin/users/${id}` : '/admin/users', {
        method: id ? 'PATCH' : 'POST',
        body: JSON.stringify(data),
      });
      
      if (res.ok) {
        closeUserModal();
        loadUsers();
      } else {
        const err = await res.json();
        alert(err.error?.message || 'Failed to save user');
      }
    });

    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      const res = await api(`/admin/users/${id}`, { method: 'DELETE' });
      if (res.ok) loadUsers();
      else alert('Failed to delete user');
    }

    // DeepL
    async function loadDeepLStatus() {
      const res = await api('/admin/settings/deepl');
      if (!res.ok) return;
      const data = await res.json();
      
      const statusEl = document.getElementById('deepl-status');
      if (data.configured) {
        statusEl.innerHTML = `
          <p class="text-green-600 font-medium">✓ Configured</p>
          <p class="text-sm text-gray-600 mt-1">Key: ${data.maskedKey}</p>
          <p class="text-sm text-gray-600">Endpoint: ${data.endpoint}</p>
          <p class="text-sm text-gray-500">Updated: ${new Date(data.updatedAt).toLocaleString()}</p>
        `;
      } else {
        statusEl.innerHTML = `<p class="text-red-600 font-medium">✗ Not configured</p>`;
      }
    }

    async function testDeepLKey() {
      const apiKey = document.getElementById('deepl-key').value.trim();
      const endpoint = document.getElementById('deepl-endpoint').value;
      
      const msgEl = document.getElementById('deepl-message');
      msgEl.textContent = apiKey ? 'Testing...' : 'Testing stored key...';
      msgEl.className = 'mt-2 text-sm text-gray-600';
      msgEl.classList.remove('hidden');
      
      const payload = { endpoint };
      if (apiKey) payload.apiKey = apiKey;
      
      const res = await api('/admin/settings/deepl/test', {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      
      if (res.ok && data.valid) {
        msgEl.textContent = `✓ Valid! Usage: ${data.usage?.character_count.toLocaleString()} / ${data.usage?.character_limit.toLocaleString()}`;
        msgEl.className = 'mt-2 text-sm text-green-600';
      } else {
        const errMsg = data?.error?.message || data?.error || 'Failed to test key';
        msgEl.textContent = `✗ Invalid: ${errMsg}`;
        msgEl.className = 'mt-2 text-sm text-red-600';
      }
    }

    // CORS settings
    function renderCorsList(origins, activeOrigins) {
      const listEl = document.getElementById('cors-list');
      if (!listEl) return;

      if (!origins || origins.length === 0) {
        listEl.innerHTML = `<p class="text-gray-500">No origins configured</p>`;
        return;
      }

      const items = origins.map(origin => `
        <div class="inline-flex items-center px-2 py-1 mr-2 mb-2 rounded bg-gray-100 text-gray-700">
          ${origin}
        </div>
      `).join('');

      let activeNote = '';
      if (Array.isArray(activeOrigins) && activeOrigins.length) {
        activeNote = `<div class="mt-2 text-xs text-gray-500">Active: ${activeOrigins.join(', ')}</div>`;
      }

      listEl.innerHTML = `${items}${activeNote}`;
    }

    async function loadCorsSettings() {
      const res = await api('/admin/settings/cors');
      if (!res.ok) {
        const listEl = document.getElementById('cors-list');
        if (listEl) listEl.textContent = 'Failed to load CORS origins';
        return;
      }
      const data = await res.json();
      renderCorsList(data.origins || [], data.activeOrigins || []);
    }

    async function addCorsOrigin() {
      const input = document.getElementById('cors-extension-id');
      const raw = input.value.trim();
      const msgEl = document.getElementById('cors-message');

      if (!raw) {
        msgEl.textContent = 'Please enter an extension ID';
        msgEl.className = 'mt-2 text-sm text-red-600';
        msgEl.classList.remove('hidden');
        return;
      }

      msgEl.textContent = 'Saving...';
      msgEl.className = 'mt-2 text-sm text-gray-600';
      msgEl.classList.remove('hidden');

      const res = await api('/admin/settings/cors', {
        method: 'POST',
        body: JSON.stringify({ extensionId: raw }),
      });

      if (res.ok) {
        const data = await res.json();
        renderCorsList(data.origins || [], data.activeOrigins || []);
        input.value = '';
        msgEl.textContent = '✓ Saved. Restart server to apply changes.';
        msgEl.className = 'mt-2 text-sm text-green-600';
      } else {
        const err = await res.json();
        msgEl.textContent = `✗ ${err.error?.message || 'Failed to save'}`;
        msgEl.className = 'mt-2 text-sm text-red-600';
      }
    }

    document.getElementById('deepl-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const apiKey = document.getElementById('deepl-key').value;
      const endpoint = document.getElementById('deepl-endpoint').value;
      
      const res = await api('/admin/settings/deepl', {
        method: 'POST',
        body: JSON.stringify({ apiKey, endpoint }),
      });
      
      if (res.ok) {
        loadDeepLStatus();
        document.getElementById('deepl-key').value = '';
        const msgEl = document.getElementById('deepl-message');
        msgEl.textContent = '✓ Saved successfully!';
        msgEl.className = 'mt-2 text-sm text-green-600';
        msgEl.classList.remove('hidden');
      } else {
        const err = await res.json();
        const msgEl = document.getElementById('deepl-message');
        msgEl.textContent = `✗ ${err.error?.message || 'Failed to save'}`;
        msgEl.className = 'mt-2 text-sm text-red-600';
        msgEl.classList.remove('hidden');
      }
    });

    // Audit
    async function loadAuditLog() {
      const res = await api('/admin/audit?limit=50');
      if (!res.ok) return;
      const data = await res.json();
      
      const tbody = document.getElementById('audit-table');
      tbody.innerHTML = data.logs.map(log => `
        <tr>
          <td class="px-6 py-4 text-sm">${new Date(log.createdAt).toLocaleString()}</td>
          <td class="px-6 py-4 text-sm">${log.actor?.email || '-'}</td>
          <td class="px-6 py-4 text-sm font-mono">${log.action}</td>
          <td class="px-6 py-4 text-sm">${log.target?.email || '-'}</td>
        </tr>
      `).join('');
    }

    // Init
    init();
  </script>
</body>
</html>
