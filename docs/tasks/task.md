# Техническое задание: модуль перевода PDF-документов

## Chrome-расширение для перевода документов — компонент PDF

---

## 1. Общее описание

Реализовать в рамках Chrome-расширения модуль перевода PDF-документов с максимальным сохранением оригинальной вёрстки. Целевой тип документов — офисная и деловая документация: договоры, акты, счета, коммерческие предложения, отчёты, спецификации, таблицы.

Бэкенд выполняет единственную функцию — проксирует запросы к DeepL API. Вся логика парсинга, обработки и сборки PDF работает на стороне расширения (в браузере).

Основные языковые пары: русский ↔ английский. Должна поддерживаться возможность расширения на другие языки.

---

## 2. Архитектура

```
Пользователь загружает PDF
        │
        ▼
[1] Парсинг PDF (pdf.js)
    → извлечение текстовых блоков с координатами, шрифтами, размерами
        │
        ▼
[2] Анализ структуры документа
    → классификация блоков: заголовки, абзацы, ячейки таблиц,
      колонтитулы, номера страниц, служебные элементы
        │
        ▼
[3] Фильтрация
    → определение блоков, не требующих перевода
      (числа, даты, артикулы, коды и т.д.)
        │
        ▼
[4] Группировка
    → объединение фрагментов в логические сегменты перевода
      (строки абзацев → абзац, слова в ячейке → ячейка)
        │
        ▼
[5] Перевод
    → батчевая отправка текстов на бэкенд (DeepL API)
    → получение переводов
        │
        ▼
[6] Компоновка перевода
    → расчёт размеров шрифта и переносов строк
      с учётом коэффициентов расширения текста
        │
        ▼
[7] Сборка PDF (pdf-lib)
    → работа с оригинальным PDF: закрашивание исходного текста,
      наложение переведённого текста
        │
        ▼
[8] Выдача результата пользователю
```

Весь пайплайн выполняется в offscreen document или service worker расширения. На каждом этапе необходимо предусмотреть обработку ошибок и информирование пользователя о прогрессе.

---

## 3. Технологический стек

| Компонент | Технология | Назначение |
|-----------|-----------|------------|
| Парсинг PDF | **pdf.js** (Mozilla) | Извлечение текста, координат, шрифтов, метаданных |
| Сборка PDF | **pdf-lib** | Модификация оригинального PDF: наложение прямоугольников и текста |
| Встраивание шрифтов | **@pdf-lib/fontkit** | Поддержка кириллицы и других алфавитов через кастомные шрифты |
| Шрифт | **Noto Sans** (Regular, Bold) | Универсальный шрифт с поддержкой кириллицы, латиницы, CJK |
| Перевод | **DeepL API** через бэкенд | Перевод текста батчами |

---

## 4. Этап 1 — Парсинг PDF

### 4.1. Извлечение текстовых блоков

Для каждой страницы извлечь массив текстовых элементов из `page.getTextContent()` (pdf.js). Каждый элемент содержит:

- `str` — текст
- `transform` — матрица трансформации (позиция, масштаб, поворот)
- `width` — ширина блока
- `fontName` — имя шрифта
- Вычисляемый `fontSize` — из матрицы трансформации

Для каждого элемента сохранить структуру:

```
{
  text: string,
  x: number,         // transform[4]
  y: number,         // transform[5]
  width: number,
  height: number,
  fontSize: number,   // вычислен из transform
  fontName: string,
  isBold: boolean,    // определить по fontName (содержит "Bold", "Bd", "Heavy")
  isItalic: boolean,  // определить по fontName (содержит "Italic", "It", "Oblique")
}
```

### 4.2. Извлечение метаданных страницы

Для каждой страницы сохранить: ширину, высоту, стили шрифтов из `textContent.styles`.

---

## 5. Этап 2 — Анализ и классификация структуры

### 5.1. Классификация блоков

Каждый текстовый блок классифицировать по типу на основе его свойств и позиции на странице.

**Номера страниц:**
- Расположены в нижней части страницы (нижние 8% высоты) или в верхней части (верхние 5%)
- Мелкий шрифт (< 10pt)
- Содержимое — число или шаблон вида «Стр. N», «Page N of M»
- НЕ переводить

**Колонтитулы:**
- Расположены в верхних 5% или нижних 8% страницы
- Мелкий шрифт
- Повторяются на нескольких страницах (если совпадает текст и позиция)
- Переводить, но с осторожностью: не ломать форматирование

**Заголовки:**
- Размер шрифта заметно крупнее основного текста документа (> 14pt или > 1.3× от медианного размера)
- Или шрифт содержит «Bold» в названии при размере ≥ 12pt
- Переводить, стараться сохранить в одну строку

**Ячейки таблиц:**
- Определяются через алгоритм детекции таблиц (см. п. 5.2)
- Переводить с агрессивным переносом строк

**Абзацы основного текста:**
- Все остальные блоки
- Стандартная стратегия перевода

### 5.2. Детекция таблиц

Таблицы в PDF не имеют семантической разметки. Детекция осуществляется по геометрическим признакам текстовых блоков.

**Алгоритм:**

1. Сгруппировать блоки в строки по близости y-координат (допуск — половина fontSize).
2. Выявить строки, содержащие ≥ 2 блока — кандидаты в строки таблицы.
3. Из кандидатов извлечь x-координаты начала блоков.
4. Кластеризовать x-координаты (допуск ~10pt). Если найдены ≥ 2 устойчивых кластера (повторяющихся от строки к строке) — это таблица.
5. Вычислить ширину каждой колонки: от текущего кластера до следующего (или до края страницы / правой границы области).
6. Пометить все блоки, попавшие в таблицу, типом `tableCell`, сохранив индекс строки и колонки.

### 5.3. Определение блоков, не требующих перевода

НЕ переводить текстовые блоки, содержащие:
- Только числа, знаки пунктуации и символы валют: `/^[\d\s.,;:/%€$¥£₽+\-—–()]+$/`
- Даты в стандартных форматах: `DD.MM.YYYY`, `MM/DD/YYYY`, `YYYY-MM-DD`
- Текст короче 2 символов (артикулы, индексы)
- Email-адреса, URL
- Номера телефонов
- ИНН, ОГРН, БИК, расчётные счета и аналогичные идентификаторы

### 5.4. Группировка в сегменты перевода

Несколько текстовых блоков, составляющих единое смысловое целое, объединить в один сегмент для перевода.

**Правила группировки:**
- Блоки на одной строке (близкий y) с одинаковым размером шрифта и небольшим горизонтальным зазором (< 2× fontSize) — склеить в одну строку.
- Последовательные строки с одинаковым размером шрифта и одинаковым x-отступом — склеить в абзац (разделить пробелом или при необходимости определить границу предложения).
- Ячейки таблиц НЕ группировать между собой — каждая ячейка является отдельным сегментом.
- Заголовки НЕ группировать с абзацами.

Для каждого сегмента вычислить и сохранить bounding box (bbox): `{ x, y, width, height }` — охватывающий прямоугольник всех входящих блоков.

---

## 6. Этап 3 — Перевод

### 6.1. Батчевая отправка

Собрать все тексты сегментов, требующих перевода, в массив. Отправить на бэкенд единым запросом (или несколькими, если количество превышает лимиты DeepL API — до 50 текстов за запрос).

```
POST /translate
{
  "texts": ["текст 1", "текст 2", ...],
  "source_lang": "RU",
  "target_lang": "EN"
}
```

### 6.2. Обработка результата

Сопоставить полученные переводы с исходными сегментами по индексу.

---

## 7. Этап 4 — Компоновка переведённого текста

### 7.1. Коэффициенты расширения текста

При переводе между языками длина текста меняется. Для предсказуемого результата используются средние коэффициенты расширения, позволяющие заранее выбрать оптимальный размер шрифта.

**Базовые коэффициенты (отношение длины перевода к длине оригинала):**

| Направление | Коэффициент |
|-------------|-------------|
| EN → RU | 1.30 |
| RU → EN | 0.77 |
| EN → DE | 1.25 |
| EN → FR | 1.20 |
| EN → ES | 1.15 |
| EN → ZH | 0.70 |
| EN → JA | 0.60 |
| EN → AR | 0.90 |

**Корректировка коэффициента по длине исходного текста.** Короткие фразы (заголовки, подписи, ячейки таблиц) имеют больший разброс в изменении длины, поэтому для них необходим дополнительный запас:

- Текст < 20 символов: `коэффициент × 1.30`
- Текст 20–50 символов: `коэффициент × 1.15`
- Текст > 50 символов: базовый коэффициент

### 7.2. Стратегия компоновки

Для каждого переведённого сегмента выполнить подбор параметров отображения. Порядок действий (от приоритетного к крайнему):

**Шаг 1 — Прямая подстановка.** Проверить, помещается ли переведённый текст в оригинальный bbox при исходном fontSize. Если да — использовать как есть.

**Шаг 2 — Расширение bbox вправо.** Проверить, есть ли свободное пространство правее сегмента (до ближайшего соседнего блока на той же высоте или до правого поля страницы). Если есть — расширить ширину bbox до доступного пространства.

**Шаг 3 — Перенос строк.** Выполнить перенос текста по словам в рамках доступной ширины при текущем fontSize. Проверить, что суммарная высота строк не наезжает на следующий сегмент ниже.

**Шаг 4 — Уменьшение шрифта.** Уменьшать fontSize с шагом 0.5pt до минимально допустимого предела. Лимит уменьшения: не более 25% от оригинала (т.е. минимум — `fontSize × 0.75`).

**Шаг 5 — Комбинация.** Уменьшенный шрифт + перенос строк + расширенный bbox. Если текст всё равно не помещается — принять наилучший возможный вариант и пометить сегмент флагом `overflow: true`.

### 7.3. Специфика по типам блоков

**Заголовки:** стараться сохранить в одну строку. Допускается уменьшение шрифта до 20% (т.е. минимум — `fontSize × 0.80`). Перенос строк — крайняя мера.

**Абзацы основного текста:** свободный перенос строк, умеренное уменьшение шрифта. Расширение bbox вниз допустимо, если до следующего сегмента достаточно пространства.

**Ячейки таблиц:** агрессивный перенос строк (допустимо до 3–4 строк вместо одной). Уменьшение шрифта до 40% (минимум — `fontSize × 0.60`, но не менее 5pt). Ячейки — самое узкое место документа, здесь качество компоновки будет наименьшим, это ожидаемо.

**Колонтитулы:** аналогично заголовкам, стараться сохранить в одну строку.

### 7.4. Визуальная консистентность

Применение коэффициентов расширения должно обеспечивать равномерное масштабирование шрифтов по документу. Недопустима ситуация, когда один абзац рендерится шрифтом 12pt, соседний — 8pt, а третий — 11pt.

**Рекомендуемый подход:** на основе коэффициента вычислить базовый уменьшенный fontSize для всех абзацев основного текста одинаково (например, для EN→RU при коэффициенте 1.3 — уменьшить все абзацы на ~15%). Затем для каждого сегмента выполнять точную подгонку от этого базового размера.

---

## 8. Этап 5 — Сборка PDF

### 8.1. Подход

Работа ведётся с оригинальным PDF-документом через библиотеку pdf-lib. Оригинальный PDF загружается и модифицируется: поверх исходного текста рисуются белые прямоугольники, затем наносится переведённый текст.

Этот подход сохраняет все нетекстовые элементы оригинала: линии, рамки таблиц, логотипы, подписи, печати, фоновые элементы.

### 8.2. Встраивание шрифтов

Встроить в документ шрифт Noto Sans (Regular и Bold) через `pdfDoc.embedFont()` с использованием fontkit. Шрифт должен быть предварительно загружен и включён в ресурсы расширения.

Выбор начертания (Regular/Bold) — на основе анализа `fontName` оригинального блока.

### 8.3. Наложение перевода

Для каждого переведённого сегмента:

1. **Закрасить оригинальный текст.** Нарисовать белый прямоугольник (`rgb(1, 1, 1)`) поверх bbox сегмента с запасом 1–2pt по каждой стороне.

2. **Нарисовать переведённый текст.** Используя рассчитанные на этапе компоновки параметры (fontSize, набор строк), нанести текст поверх белого прямоугольника. Цвет текста — чёрный (`rgb(0, 0, 0)`). Межстрочный интервал — `fontSize × 1.2`.

### 8.4. Координаты

Система координат PDF: начало в левом нижнем углу, y растёт вверх. При рендеринге текста учитывать это: первая строка рисуется в верхней части bbox, каждая следующая — ниже (y уменьшается).

---

## 9. Интерфейс пользователя

### 9.1. Процесс перевода

1. Пользователь загружает PDF (через кнопку или drag-and-drop в интерфейсе расширения).
2. Пользователь выбирает исходный и целевой язык.
3. Нажимает «Перевести».
4. Отображается прогресс-бар с этапами: парсинг → анализ → перевод → сборка.
5. По завершении — автоматическое скачивание переведённого PDF или кнопка «Скачать».

### 9.2. Обработка ошибок

- Если PDF защищён паролем — сообщить пользователю.
- Если PDF содержит только сканы (изображения, нет текстового слоя) — сообщить, что перевод невозможен (OCR не поддерживается в текущей версии).
- Если бэкенд недоступен или DeepL вернул ошибку — сообщить с предложением повторить.
- Если отдельные сегменты не поместились (overflow) — в UI не акцентировать, но обеспечить читаемость текста в любом случае.

---

## 10. Ограничения и допущения текущей версии

- Поддерживаются только PDF с текстовым слоем (не сканы).
- OCR не реализуется.
- Замена шрифта: оригинальные шрифты документа заменяются на Noto Sans. Визуальное отличие от оригинала в начертании шрифтов — ожидаемо и допустимо.
- Таблицы без видимых рамок (только текстовые) детектируются эвристически и могут определяться неточно.
- Для документов с многоколоночной вёрсткой (газетного типа) качество может быть ниже. Это не приоритетный сценарий.
- Графические элементы (логотипы, печати, подписи, диаграммы) не затрагиваются и остаются на месте.
- Текст внутри растровых изображений (скриншоты, вставленные картинки) не переводится.

---

## 11. Критерии приёмки

1. PDF с типовым договором (2–5 страниц, текст + таблица + колонтитулы) переводится RU→EN и EN→RU с сохранением читаемой вёрстки.
2. Все нетекстовые элементы оригинала сохраняются без искажений.
3. Текст в таблицах переведён и читаем (допускается уменьшение шрифта и перенос строк в ячейках).
4. Заголовки визуально выделяются (крупнее основного текста).
5. Номера страниц, даты, числовые значения не искажены.
6. Время обработки документа 5 страниц — не более 30 секунд (без учёта времени ответа DeepL API).
7. Результат открывается без ошибок в Chrome, Adobe Reader, Preview (macOS).
