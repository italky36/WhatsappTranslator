# Этап 8: Кириллица, тестирование и полировка

## Цель
Обеспечить корректную работу с кириллицей во всех форматах, провести комплексное тестирование, добавить финальные UX-улучшения и исправить выявленные проблемы.

## Контекст
К этому этапу все функциональные модули реализованы (Этапы 1-7). Требуется:
- Верифицировать работу с кириллицей
- Протестировать граничные случаи
- Отполировать UX
- Оптимизировать производительность для больших файлов

---

## Задачи

### 8.1. Тестирование кириллицы

#### Excel
Тестовые сценарии:
1. **Кириллические данные в ячейках** — перевести файл EN→RU, убедиться что русские буквы отображаются корректно
2. **Кириллические названия листов** — лист "Итоги", "Данные за январь" — не должны ломаться
3. **Смешанный текст** — ячейки с кириллицей + латиницей + цифрами
4. **Кириллические шрифты** — если в ячейке шрифт "Times New Roman" с кириллицей, после перевода шрифт не должен меняться
5. **Merged cells с кириллицей** — объединённые ячейки
6. **Длинный кириллический текст** — ячейка с 500+ символами

Проверки:
- Открыть результат в Excel/LibreOffice — символы отображаются
- Нет символов `?`, `□`, `ÐÐ°`, `Ã` (признаки битой кодировки)
- Форматирование сохранено

#### Word
Тестовые сценарии:
1. **Параграфы с кириллицей** — обычный русский текст
2. **Таблицы с кириллицей** — текст в ячейках таблиц
3. **Заголовки с кириллическими стилями** — Heading 1, Heading 2 на русском
4. **Шрифты**: Arial, Times New Roman, Calibri с кириллицей
5. **Жирный, курсив** кириллический текст — форматирование сохраняется
6. **Headers/Footers** с кириллицей

Проверки:
- Открыть в Word/LibreOffice — всё читаемо
- XML внутри .docx содержит корректный UTF-8

#### PDF
Тестовые сценарии:
1. **PDF с кириллическим текстовым слоем** — текст извлекается полностью
2. **PDF без текстового слоя (скан)** — корректное уведомление
3. **Смешанный PDF** — часть страниц с текстом, часть — сканы
4. **Кириллица в разных кодировках внутри PDF** — WinAnsiEncoding vs Unicode

Проверки:
- Извлечённый текст не содержит мусорных символов
- Текстовый файл результата (.txt) с BOM корректно открывается в Блокноте Windows
- Превью на странице отображается корректно

#### UI
1. Все i18n тексты на RU отображаются корректно
2. Названия файлов с кириллицей в карточках не обрезаются
3. Кириллица в мини-превью читаема
4. Полноэкранный превью с кириллицей не ломает верстку

### 8.2. Исправление проблем кодировки

**Потенциальные проблемы и решения:**

1. **SheetJS и кириллица**:
   - Использовать `{ codepage: 65001 }` при чтении .xls (CP65001 = UTF-8)
   - Для .xls: `XLSX.read(data, { type: 'array', codepage: 65001 })`

2. **Word XML и кириллица**:
   - При сериализации XML убедиться что `<?xml version="1.0" encoding="UTF-8"?>`
   - Не использовать `textContent` для замены — он экранирует спецсимволы. Использовать DOM API

3. **PDF.js и кириллица**:
   - PDF.js может некорректно извлекать текст из PDF с нестандартными кириллическими font encodings
   - Проверить `item.str` в `textContent.items` на наличие мусора
   - Если обнаружен мусор — попробовать нормализацию Unicode: `text.normalize('NFC')`

4. **Имена файлов**:
   - `URL.createObjectURL` + `<a download="...">` корректно обрабатывает кириллические имена
   - В JSZip при добавлении файлов: `zip.file(fileName, blob)` — имена в UTF-8

5. **BOM для текстовых файлов**:
   - Добавлять UTF-8 BOM (`\uFEFF` или `[0xEF, 0xBB, 0xBF]`) к .txt файлам
   - Это необходимо для корректного отображения в Windows Notepad

### 8.3. Оптимизация для больших файлов

**Web Workers** для тяжёлых операций:

1. **Парсинг Excel с 10,000+ ячейками**:
   - SheetJS поддерживает работу в Web Worker
   - Вынести парсинг в Worker если количество ячеек > 5000
   - Показывать "Анализ файла..." без блокировки UI

2. **Парсинг PDF с 50+ страницами**:
   - PDF.js уже использует Worker (`pdf.worker.min.js`)
   - Убедиться что worker подключён и работает

3. **Сборка большого .docx**:
   - JSZip compression может быть медленной для больших файлов
   - Использовать `compression: 'STORE'` для файлов > 10MB (без сжатия, но быстро)

**Индикаторы:**
- Для файлов > 5MB показывать "Обработка большого файла..." с анимацией
- Для batch-переводов > 200 сегментов — показывать "Сегмент X из Y"

### 8.4. UX-полировка

#### Анимации
- Плавное появление карточек результатов: `opacity 0→1`, `transform translateY(10px)→0`
- Плавное переключение между view (upload → progress → results)
- Анимация прогресс-бара: `transition: width 0.3s ease`

#### Состояния загрузки
- Skeleton-загрузка при проверке авторизации
- Spinner при загрузке списка языков
- Пульсирующая анимация при парсинге файлов

#### Уведомления
Создать лёгкую систему уведомлений (toast notifications):
```javascript
function showNotification(message, type = 'info') {
  // type: 'info', 'success', 'warning', 'error'
  // Показать toast в правом верхнем углу
  // Автоматическое скрытие через 3-5 секунд
}
```

Использовать для:
- "Файл добавлен" (info)
- "Формат не поддерживается" (error)
- "Файл скачан" (success)
- "Лимит символов близок к исчерпанию" (warning)

#### Адаптивность
- Мобильные устройства (хотя это расширение, страница может открываться на маленьких экранах):
  - Drop-зона занимает всю ширину
  - Карточки в 1 колонку
  - Кнопки полной ширины
- Большие экраны (> 1400px):
  - Карточки до 4 в ряд
  - Фиксированная ширина контента

#### Клавиатурная навигация
- `Escape` в полноэкранном превью → вернуться к сетке
- `Tab` навигация по кнопкам
- `Enter` на карточке → открыть превью

### 8.5. Обработка граничных случаев

1. **Пустой файл** — показать "Файл пуст, нечего переводить"
2. **Файл только с числами (Excel)** — "Нет текста для перевода"
3. **Файл > 50MB** — отклонить при загрузке
4. **1000+ сегментов** — показать предупреждение "Большой файл, перевод может занять время"
5. **Потеря связи во время перевода** — retry + предложить скачать частичный результат
6. **Истечение JWT токена во время перевода** — background.js автоматически обновляет (уже реализовано)
7. **Закрытие вкладки во время перевода** — нет сохранения (предупредить через `beforeunload`)
8. **Повторная загрузка того же файла** — разрешить (может быть обновлённая версия)

```javascript
// Предупреждение при закрытии во время перевода
window.addEventListener('beforeunload', (e) => {
  if (translationManager.isTranslating()) {
    e.preventDefault();
    e.returnValue = '';  // Показать стандартный диалог браузера
  }
});
```

### 8.6. Финальная проверка кода

- Убедиться что нет `console.log` (только `console.error` для реальных ошибок)
- Проверить что нет утечек памяти (`URL.revokeObjectURL` вызывается)
- Проверить что `chrome.storage.local` не засоряется данными переводов
- Убедиться что все event listeners корректно удаляются при смене view
- Проверить CSP (Content Security Policy) — нет inline scripts/styles через `eval` или `new Function`

### 8.7. Совместимость

Проверить работу в:
- Google Chrome (последняя версия)
- Microsoft Edge (последняя версия)
- Проверить на Windows 10/11 (основная целевая платформа)

---

## i18n — финальные ключи

```javascript
// EN
docEmptyFile: 'File is empty, nothing to translate',
docNoTextContent: 'No text content to translate',
docLargeFileWarning: 'Large file. Translation may take a while.',
docCloseWarning: 'Translation is in progress. Are you sure you want to leave?',
docFileAdded: 'File added',
docConnectionLost: 'Connection lost. Retrying...',

// RU
docEmptyFile: 'Файл пуст, нечего переводить',
docNoTextContent: 'Нет текстового содержимого для перевода',
docLargeFileWarning: 'Большой файл. Перевод может занять время.',
docCloseWarning: 'Перевод в процессе. Вы уверены, что хотите уйти?',
docFileAdded: 'Файл добавлен',
docConnectionLost: 'Соединение потеряно. Повторная попытка...',
```

---

## Файлы для изменения
- `extension/src/document/document.js` — toast-уведомления, beforeunload, оптимизации
- `extension/src/document/document.css` — анимации, адаптивность, toast-стили
- `extension/src/document/parsers/excel-parser.js` — codepage для .xls, оптимизация больших файлов
- `extension/src/document/parsers/word-parser.js` — проверка UTF-8 XML
- `extension/src/document/parsers/pdf-parser.js` — нормализация Unicode
- `extension/src/document/download-manager.js` — BOM для .txt

## Файлы для создания
- Нет

---

## Критерии приёмки

1. Кириллический текст корректно переводится и отображается во всех форматах (Excel, Word, PDF)
2. Нет битых символов (`?`, `□`, `ÐÐ°`) в результатах
3. .txt файлы с кириллицей корректно открываются в Windows Notepad
4. Файлы > 5MB обрабатываются без зависания UI
5. Toast-уведомления работают для всех событий
6. `beforeunload` предупреждает при закрытии во время перевода
7. Escape в превью возвращает к сетке
8. Нет console.log в production коде
9. Нет утечек памяти при многократных переводах
10. Работает в Chrome и Edge
11. Адаптивная верстка от 800px до 1920px
12. Все i18n тексты присутствуют для EN и RU

## Зависимости
- Все предыдущие этапы (1-7) должны быть завершены
